% Copyright 2016 Slavonic Computing Initialive
% http://sci.ponomar.net
% 
\ProvidesPackage{cu-calendar}[2016/03/30 v1.0 CU Calendars]

\@ifundefined{detokenize}{%
  \PackageError{cu-num}%
    {You must upgrade your TeX distribution to be able to use this package}%
    {This package depends on eTeX-based engine}%
}{}

\RequirePackage{intcalc}
\RequirePackage{etoolbox}

%
% Tools
%
\def\cu@jdn#1#2#3#4{%
  \expandafter\cu@@jdn
  \expandafter{\the\numexpr \intcalcDiv{14 - #2}{12} \relax}{#1}{#2}{#3}{#4}%
}%
\def\cu@@jdn#1#2#3#4#5{%
  \expandafter\cu@@@jdn
  \expandafter{\the\numexpr #2 + 4800 - #1\relax}{#1}{#2}{#3}{#4}{#5}%
}%
\def\cu@@@jdn#1#2#3#4#5#6{%  y a year month day
  \expandafter\cu@@@@jdn
  \expandafter{\the\numexpr #4 - 3 + 12 * (#2)\relax}{#1}{#2}{#3}{#4}{#5}{#6}%
}%
\def\cu@@@@jdn#1#2#3#4#5#6#7{% m y a year month day
  \expandafter #7%
  \expandafter{\the\numexpr #6 + 
    \intcalcDiv{153 * (#1) + 2}{5} + (365 * (#2)) + \intcalcDiv{#2}{4} - 32083\relax}{#2}%
}%
\def\greg@#1#2{% jdn_julian y
  \expandafter\greg@@
  \expandafter{\the\numexpr #1 - \intcalcDiv{#2}{100}\relax}{#2}%
}%
\def\greg@@#1#2{% jdn_julian y
  \the\numexpr #1 + \intcalcDiv{#2}{400} + 32083 - 32045\relax%
}%
%
\def\cu@jdnFromJulianDate#1#2#3{%
  \cu@jdn{#1}{#2}{#3}\@firstoftwo
}%
\def\cu@jdnFromGregorianDate#1#2#3{%
  \cu@jdn{#1}{#2}{#3}\greg@
}%
%
\def\cu@calendar#1{%
  \expandafter\cu@@calendar
  \expandafter{\the\numexpr (#1 + 1401) * 4 + 3\relax}%
}%
\def\cu@@calendar#1{% e
  \expandafter\cu@@@calendar
  \expandafter{\the\numexpr 2 + 
    \intcalcMul{5}{\intcalcDiv{\intcalcMod{#1}{1461}}{4}} \relax}{#1}%
}%
\def\cu@@@calendar#1#2{%  h  e
  \expandafter\cu@@@@calendar
  \expandafter{\the\numexpr 1 + \intcalcDiv{\intcalcMod{#1}{153}}{5}\relax}{#1}{#2}%
}%
\def\cu@@@@calendar#1#2#3{%  day h  e
  \expandafter\cu@@@@@calendar
  \expandafter{\the\numexpr 1 + 
    \intcalcMod{\intcalcAdd{\intcalcDiv{#2}{153}}{2}}{12}\relax}{#1}{#2}{#3}%
}%
\def\cu@@@@@calendar#1#2#3#4{% month day h  e
  \the\numexpr 
    \intcalcDiv{#4}{1461} - 4716 + \intcalcDiv{14-#1}{12}\relax -#1-#2%
}%
\def\cu@calendarJulian#1{\cu@calendar{#1}}%
\def\cu@calendarGregorian#1{%
  \expandafter\cu@calendar\expandafter{%
    \the\numexpr #1 +
    \intcalcDiv{\intcalcMul{\intcalcDiv{274277 + 4 * (#1)}{146097}}{3}}{4} - 38
    \relax
}}%
%
\def\cu@julianToGregorian#1#2#3{%
  \cu@calendarGregorian{\cu@jdnFromJulianDate{#1}{#2}{#3}}%
}%
\def\cu@gregorianToJulian#1#2#3{%
  \cu@calendarJulian{\cu@jdnFromGregorianDate{#1}{#2}{#3}}%
}%
\let\cu@julianFromGregorian\cu@gregorianToJulian
\let\cu@gregorianFromJulian\cu@julianToGregorian
%
% User API
%
\def\cuJulianDate#1#2#3{%
  \expandafter\cu@formatDate\number\cu@julianFromGregorian{#1}{#2}{#3}\relax
}%
\def\cuJulianToday{%
  \cuAsJulianDate{\year}{\month}{\day}%
}%
\def\cuGregorianDate#1#2#3{%
  \cu@formatDate#1-#2-#3\relax
}%
\def\cuGregorianToday{%
  \cu@formatDate\year-\month-\day\relax
}%
\def\cu@formatDate#1-#2-#3\relax{%
  #3\space
  \ifcase#2\or%
    і҆аннꙋа́рїа\or
    феврꙋа́рїа\or
    ма́рта\or
    а҆прі́ллїа\or
    ма́їа\or
    і҆ꙋ́нїа\or
    і҆ꙋ́лїа\or
    а҆́ѵгꙋста\or
    септе́мврїа\or
    ѻ҆ктѡ́врїа\or
    ное́мврїа\or
    деке́мврїа\fi%
  \space л.\space\number#1%
}%
%
% Indiction "year"
%
\def\cuIndiction#1{%
  \expandafter\@cuIndiction
  \expandafter{\intcalcMod{#1}{15}}%
}%
\def\@cuIndiction#1{%
  \intcalcAdd{#1}{15 - 15 * \intcalcDiv{#1+14}{15}}%
}%
%